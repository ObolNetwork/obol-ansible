- name: Ensure docker network exists
  community.docker.docker_network:
    name: "{{ docker_network_name }}"
    state: present
  tags:
    - prometheus
    - monitoring
    - network

- name: Validate remote write settings
  ansible.builtin.assert:
    that:
      - prom_remote_write_url | length > 0
      - prom_remote_write_token | length > 0
    fail_msg: "prom_remote_write_url and prom_remote_write_token must be set when prom_remote_write_enabled is true"
  when: prom_remote_write_enabled | default(false)
  tags:
    - prometheus
    - monitoring
    - validation

- name: Ensure Prometheus directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop:
    - "{{ prometheus_config_dir }}"
    - "{{ prometheus_data_dir }}"
  tags:
    - prometheus
    - monitoring
    - setup

- name: Render Prometheus config
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ prometheus_config_dir }}/prometheus.yml"
    mode: '0644'
  tags:
    - prometheus
    - monitoring
    - configuration

- name: Deploy Prometheus
  community.docker.docker_container:
    name: "{{ prometheus_container_name }}"
    image: "{{ prometheus_image }}:{{ prometheus_version }}"
    state: started
    restart_policy: unless-stopped
    user: "{{ prometheus_user }}"
    ports: "{{ [prometheus_bind_address ~ ':' ~ prometheus_port ~ ':9090'] if prometheus_expose_port | default(false) else omit }}"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    volumes:
      - "{{ prometheus_config_dir }}/prometheus.yml:/etc/prometheus/prometheus.yml:ro"
      - "{{ prometheus_data_dir }}:/prometheus"
    networks:
      - name: "{{ docker_network_name }}"
  tags:
    - prometheus
    - monitoring
    - deploy
